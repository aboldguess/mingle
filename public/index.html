<!DOCTYPE html>
<!--
  index.html
  Mini README:
  - Purpose: renders the main 3D meeting interface and surrounding UI chrome.
  - Structure:
    1. Page styling and navigation bar
    2. On-screen usage instructions with minimise toggle
    3. Local webcam thumbnail with minimise button
    4. Options sidebar with microphone mute and manual look controls
    5. A-Frame scene setup with assets, cameras, avatar and spectate marker
       (local and remote avatars display webcam feeds via WebRTC)
       - Default GLB assets live in /public/assets and include a body and CRT TV
         model. The TV model's `screen` mesh is textured with the webcam feed.
    5. Client scripts for movement and navbar functionality

    6. Client scripts for movement and navbar functionality
  - Notes: A-Frame's default WASD controls are disabled on all cameras so that
    movement is handled exclusively by custom code in mingle_client.js.
-->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mingle Prototype</title>
  <style>
    /* Make the scene occupy the full viewport */
    html, body { width: 100%; height: 100%; margin: 0; font-family: Arial, sans-serif; }
    a-scene { width: 100%; height: 100%; }
    /* Simple navigation bar anchored to the top of the page */
    nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 50px;
      background: #333;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 10px;
      z-index: 200;
    }
    nav a { color: #fff; text-decoration: none; font-weight: bold; }
    .profile-menu { position: relative; }
    .profile-button {
      width: 40px;
      height: 40px;
      border-radius: 20px;
      cursor: pointer;
    }
    .dropdown {
      position: absolute;
      right: 0;
      top: 50px;
      background: #fff;
      color: #333;
      list-style: none;
      padding: 0;
      margin: 0;
      border: 1px solid #ccc;
      display: none;
      min-width: 180px;
    }
    .dropdown li a {
      display: block;
      padding: 10px 15px;
      color: #333;
    }
    .dropdown li a:hover { background: #f0f0f0; }
    .dropdown.show { display: block; }
    #instructions {
      position: absolute;
      top: 60px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 10px;
      z-index: 100;
    }
    #instructionsToggle {
      position: absolute;
      top: 60px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      padding: 2px 6px;
      cursor: pointer;
      z-index: 101;
    }
    #sidebar {
      position: fixed;
      top: 160px;
      right: 10px;
      width: 220px;
      background: rgba(255,255,255,0.9);
      color: #000;
      padding: 10px;
      border: 1px solid #ccc;
      z-index: 150;
      font-size: 14px;
    }
    #status {
      margin-top: 10px;
      font-size: 12px;
      color: #333;
    }
    /* Containers for on-screen joysticks on touch devices */
    #moveJoystick, #lookJoystick {
      position: fixed;
      width: 120px;
      height: 120px;
      z-index: 180;
    }
    #moveJoystick { left: 0; bottom: 0; }
    #lookJoystick { right: 0; bottom: 0; display: none; }

    /* Local webcam thumbnail positioned above the sidebar */
    #selfPreview {
      position: fixed;
      top: 60px;
      right: 10px;
      width: 120px;
      border: 2px solid #333;
      background: #000;
      z-index: 151;
    }
    #selfPreview video {
      width: 100%;
      display: block;
    }
    #selfPreview.hidden video {
      display: none;
    }
    #selfPreviewToggle {
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      width: 20px;
      height: 20px;
      border-radius: 0 0 0 10px;
      cursor: pointer;
      font-weight: bold;
    }
    #selfPreview.hidden {
      height: 20px;
    }
  </style>
  <!--
    Load A-Frame and supporting libraries *before* the scene so that all
    custom elements are registered when the HTML is parsed. The configuration
    script exposes whether the server was launched in debug mode.
  -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.8.1/dist/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/nipplejs@0.10.2/dist/nipplejs.min.js"></script>
  <script src="/config.js"></script>
</head>
<body>
  <nav>
    <div><a href="/index.html">Mingle</a></div>
    <div class="profile-menu">
      <img src="https://via.placeholder.com/40" alt="Profile" id="profileButton" class="profile-button" />
      <ul id="profileDropdown" class="dropdown">
        <li><a href="manage_profiles.html">Manage Profiles</a></li>
        <li><a href="learning_zone.html">Learning Zone</a></li>
        <li><a href="my_details.html">My Details</a></li>
        <li><a href="subscription_details.html">Subscription Details</a></li>
        <li><a href="manage_users.html">Manage Users</a></li>
        <li><a href="#" id="signOut">Sign out</a></li>
      </ul>
    </div>
  </nav>
  <button id="instructionsToggle" aria-label="Hide instructions">&minus;</button>
  <div id="instructions">
    <p>Use WASD to move and mouse to look. Click to lock pointer.</p>
    <p>Use the profile button in the top-right to access account options.</p>
    <p>Allow microphone access when prompted so others can hear you. Use the mute control in the sidebar to silence yourself.</p>
    <p>On touch devices, a left thumbstick mirrors WASD movement. Enable Manual look to use a right thumbstick for camera pan/tilt.</p>
  </div>

  <div id="selfPreview">
    <button id="selfPreviewToggle" aria-label="Hide webcam preview">&minus;</button>
    <video id="selfPreviewVideo" autoplay playsinline muted></video>
  </div>

  <aside id="sidebar">
    <label><input type="checkbox" id="muteToggle"> Mute microphone <span id="micStatus">(live)</span></label><br />
    <label><input type="checkbox" id="lookToggle"> Manual look</label><br />
  </aside>

  <!-- Joystick containers positioned via CSS for touch navigation -->
  <div id="moveJoystick"></div>
  <div id="lookJoystick"></div>

  <!-- Main A-Frame scene. Removing 'embedded' allows full-screen rendering -->
  <!-- Disable the default loading screen so the environment appears even if the
       webcam stream takes a while to initialise. -->
  <a-scene loading-screen="enabled: false">
    <a-assets>
      <!--
        Include the video element used for the local webcam feed. The `muted`
        attribute ensures browsers allow autoplay which lets A-Frame finish
        loading instead of leaving the user on the default blue loading screen.
      -->
      <video id="localVideo" autoplay playsinline muted></video>
      <!--
        Default avatar assets are loaded dynamically if corresponding GLB files
        exist in /public/assets. This avoids bundling binary models in the
        repository while still allowing runtime customisation.
      -->
    </a-assets>

    <!-- Simple floor and lighting -->
    <a-plane rotation="-90 0 0" width="20" height="20" color="#7BC8A4"></a-plane>
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>
    <a-entity light="type: directional; intensity: 0.8" position="0 1 1"></a-entity>

    <!-- Player entity that holds the camera and avatar. Movement is handled by a
         custom controller in mingle_client.js so we omit the built-in
         `wasd-controls`. The avatar starts hidden so it does not obstruct the
         first-person view but becomes visible in spectate mode. -->
    <a-entity id="player" position="0 1.6 0">
      <!-- The avatar now combines a body model with a CRT TV head. The TV's
           `screen` mesh is dynamically textured with the user's webcam feed
           once the model loads. Remote participants mirror this layout. -->
      <a-camera id="playerCamera" position="0 0 0" look-controls="pointerLockEnabled: true" wasd-controls="enabled: false"></a-camera>
      <a-entity id="avatar" position="0 0 0" visible="false">
        <!-- Model assignments occur in mingle_client.js once assets are loaded. -->
        <a-entity id="avatarBody"></a-entity>
        <a-entity id="avatarTV" position="0 0.8 0"></a-entity>
      </a-entity>
    </a-entity>

    <!-- Spectator camera that remains fixed at predefined viewpoints. Mouse
         movement does not influence its orientation. A small marker indicates
         its position when spectating. -->
    <a-camera id="spectateCam" position="10 10 10" rotation="-35 -45 0" fov="80"
              visible="false" wasd-controls="enabled: false"
              look-controls="pointerLockEnabled: true"></a-camera>
    <a-box id="spectateMarker" width="0.5" height="0.5" depth="0.5" visible="false"></a-box>
  </a-scene>

  <!-- Client logic is loaded last once the DOM and libraries are ready -->
  <script src="js/mingle_client.js"></script>
  <script src="js/mobile_controls.js"></script>
  <script src="js/webrtc.js"></script>
  <script src="js/ui_controls.js"></script>
  <script src="js/webcam_preview.js"></script>
  <script src="js/mingle_navbar.js"></script>
</body>
</html>
